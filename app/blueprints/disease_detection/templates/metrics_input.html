{% extends "base.html" %} {% block extra_head %}
<style>
  .form-section {
    transform: translateY(20px);
    opacity: 0;
    animation: slideIn 0.5s ease forwards;
  }

  @keyframes slideIn {
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .form-section:nth-child(1) {
    animation-delay: 0.1s;
  }
  .form-section:nth-child(2) {
    animation-delay: 0.2s;
  }
  .form-section:nth-child(3) {
    animation-delay: 0.3s;
  }
  .form-section:nth-child(4) {
    animation-delay: 0.4s;
  }

  .input-group:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease;
  }
</style>
{% endblock %} {% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
    <div class="p-6">
      <h1
        class="text-3xl font-bold text-heartred-600 dark:text-heartred-400 mb-8 text-center"
      >
        Heart Health Assessment
      </h1>

      <!-- BMI Calculator Card -->
      <div
        class="form-section bg-gradient-to-r from-heartred-50 to-white dark:from-gray-700 dark:to-gray-800 rounded-lg p-6 mb-8 shadow-sm border border-heartred-100 dark:border-gray-600"
      >
        <div class="flex items-center mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 text-heartred-500 mr-2"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            />
          </svg>
          <h3 class="text-lg font-semibold">BMI Calculator</h3>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-300">
          BMI = weight(kg) / (height(m))²
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          Example: For a person weighing 50kg and height 1.5m, BMI = 50/(1.5)² =
          22.22
        </p>
      </div>

      <form id="metricsInputForm" class="space-y-8" action="" method="POST">
        <!-- Personal Information Section -->
        <div
          class="form-section bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700"
        >
          <div class="flex items-center mb-6">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-heartred-500 mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              />
            </svg>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">
              Personal Information
            </h3>
          </div>
          {{hidden_tag()}}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Age -->
            <div class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
              <!-- input label -->
              {{form.age.label ( class="block text-sm font-medium text-gray-700
              dark:text-gray-300" )}}
              <!-- input field -->
              {{form.age( class="mt-1 block w-full rounded-md border-gray-300
              shadow-sm focus:border-heartred-500 focus:ring-heartred-500
              dark:bg-gray-600 dark:border-gray-500 dark:text-white" , required=
              true)}}
            </div>

            <!-- Gender -->
            <div class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >Gender</label
              >
              <div class="mt-2 space-x-4">
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="gender"
                    value="male"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">Male</span>
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="gender"
                    value="female"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">Female</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Lifestyle Section -->
        <div
          class="form-section bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700"
        >
          <div class="flex items-center mb-6">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-heartred-500 mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">
              Lifestyle Factors
            </h3>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Smoking Status -->
            <div class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >Current Smoker?</label
              >
              <div class="mt-2 space-x-4">
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="smoker"
                    value="yes"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">Yes</span>
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="smoker"
                    value="no"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">No</span>
                </label>
              </div>
            </div>

            <!-- Cigarettes per day -->
            <div
              id="cigarettesPerDay"
              class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700 hidden"
            >
              <label
                for="cigarettes"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >Cigarettes per day</label
              >
              <input
                type="number"
                id="cigarettes"
                name="cigarettes"
                min="1"
                max="100"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-heartred-500 focus:ring-heartred-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
              />
            </div>
          </div>
        </div>

        <!-- Medical History Section -->
        <div
          class="form-section bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700"
        >
          <div class="flex items-center mb-6">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-heartred-500 mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">
              Medical History
            </h3>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- BP Medicines -->
            <div class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >Taking BP Medicines?</label
              >
              <div class="mt-2 space-x-4">
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="bp_meds"
                    value="yes"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">Yes</span>
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="bp_meds"
                    value="no"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">No</span>
                </label>
              </div>
            </div>

            <!-- Prevalent Stroke -->
            <div class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >Previous Stroke History?</label
              >
              <div class="mt-2 space-x-4">
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="stroke"
                    value="yes"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">Yes</span>
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="stroke"
                    value="no"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">No</span>
                </label>
              </div>
            </div>

            <!-- Prevalent Hypertension -->
            <div class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >Hypertension?</label
              >
              <div class="mt-2 space-x-4">
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="hypertension"
                    value="yes"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">Yes</span>
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="hypertension"
                    value="no"
                    class="form-radio text-heartred-600"
                  />
                  <span class="ml-2">No</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Current Health Metrics Section -->
        <div
          class="form-section bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700"
        >
          <div class="flex items-center mb-6">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-heartred-500 mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
              />
            </svg>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">
              Current Health Metrics
            </h3>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Blood Pressure -->
            <div class="space-y-4">
              <div
                class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700"
              >
                <label
                  for="systolic"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >
                  Systolic Blood Pressure (mmHg)
                </label>
                <input
                  type="number"
                  id="systolic"
                  name="systolic"
                  required
                  min="70"
                  max="250"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-heartred-500 focus:ring-heartred-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                />
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                  Normal range: 90-120 mmHg
                </p>
              </div>

              <div
                class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700"
              >
                <label
                  for="diastolic"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >
                  Diastolic Blood Pressure (mmHg)
                </label>
                <input
                  type="number"
                  id="diastolic"
                  name="diastolic"
                  required
                  min="40"
                  max="150"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-heartred-500 focus:ring-heartred-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                />
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                  Normal range: 60-80 mmHg
                </p>
              </div>
            </div>

            <!-- Other Metrics -->
            <div class="space-y-4">
              <div
                class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700"
              >
                <label
                  for="cholesterol"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >
                  Total Cholesterol (mg/dL)
                </label>
                <input
                  type="number"
                  id="cholesterol"
                  name="cholesterol"
                  required
                  min="100"
                  max="600"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-heartred-500 focus:ring-heartred-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                />
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                  Normal range: 125-200 mg/dL
                </p>
              </div>

              <div
                class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700"
              >
                <label
                  for="glucose"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >
                  Blood Glucose (mg/dL)
                </label>
                <input
                  type="number"
                  id="glucose"
                  name="glucose"
                  required
                  min="40"
                  max="400"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-heartred-500 focus:ring-heartred-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                />
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                  Normal range: 70-100 mg/dL (fasting)
                </p>
              </div>
            </div>

            <!-- Heart Rate and BMI -->
            <div class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
              <label
                for="heart_rate"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Heart Rate (bpm)
              </label>
              <input
                type="number"
                id="heart_rate"
                name="heart_rate"
                required
                min="40"
                max="200"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-heartred-500 focus:ring-heartred-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
              />
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                Normal range: 60-100 bpm
              </p>
            </div>

            <div class="input-group p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
              <label
                for="bmi"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                BMI
              </label>
              <input
                type="number"
                id="bmi"
                name="bmi"
                required
                min="10"
                max="50"
                step="0.1"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-heartred-500 focus:ring-heartred-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
              />
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                Normal range: 18.5-24.9
              </p>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-center mt-8">
          <button
            type="submit"
            class="px-8 py-3 bg-heartred-600 text-white rounded-lg hover:bg-heartred-700 focus:outline-none focus:ring-2 focus:ring-heartred-500 focus:ring-offset-2 transform transition-transform hover:scale-105"
          >
            Assess My Heart Health
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Result Modal -->
<div
  id="resultModal"
  class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
>
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800"
  >
    <div class="mt-3 text-center">
      <h3
        class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100"
        id="resultTitle"
      ></h3>
      <div class="mt-2 px-7 py-3">
        <p
          class="text-sm text-gray-500 dark:text-gray-400"
          id="resultMessage"
        ></p>
      </div>
      <div class="items-center px-4 py-3">
        <button
          id="generateReportBtn"
          class="px-4 py-2 bg-heartred-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-heartred-700 focus:outline-none focus:ring-2 focus:ring-heartred-500"
        >
          Generate Report
        </button>
        <button
          id="closeModal"
          class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_scripts %}
<script>
  // Show/hide cigarettes per day field based on smoking status
  document.querySelectorAll('input[name="smoker"]').forEach((radio) => {
    radio.addEventListener("change", function () {
      const cigarettesField = document.getElementById("cigarettesPerDay");
      cigarettesField.classList.toggle("hidden", this.value === "no");
      if (this.value === "no") {
        document.getElementById("cigarettes").value = "";
      }
    });
  });

  // Form submission handler
  document
    .getElementById("healthMetricsForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      // Collect form data
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());

      try {
        // Send data to backend
        const response = await fetch(
          "/heart-disease-detection/api/assess-heart-health",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          }
        );

        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        // Show result modal
        const modal = document.getElementById("resultModal");
        const title = document.getElementById("resultTitle");
        const message = document.getElementById("resultMessage");

        title.textContent = result.risk
          ? "High Risk Detected"
          : "Low Risk Detected";

        const probability = (result.probability * 100).toFixed(1);
        const riskLevel = result.risk ? "high" : "low";

        message.textContent = `Based on your inputs, you appear to be at ${riskLevel} risk for heart disease (${probability}% probability). ${
          result.risk
            ? "Please consult with a healthcare professional for a thorough evaluation."
            : "Keep up the healthy lifestyle!"
        }`;

        modal.classList.remove("hidden");
      } catch (error) {
        console.error("Error:", error);
        alert(
          error.message ||
            "An error occurred while processing your request. Please try again."
        );
      }
    });

  // Close modal handler
  document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("resultModal").classList.add("hidden");
  });

  // Generate report handler
  document
    .getElementById("generateReportBtn")
    .addEventListener("click", async () => {
      try {
        const response = await fetch(
          "/heart-disease-detection/api/generate-report",
          {
            method: "GET",
          }
        );

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "HeartWise-Report.pdf";
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error("Error:", error);
        alert(
          "An error occurred while generating the report. Please try again."
        );
      }
    });

  function showResult(response) {
    if (response.error) {
      throw new Error(response.error);
    }

    const risk = response.risk;
    const probability = (response.probability * 100).toFixed(1);
    const riskResult = risk ? "YES" : "NO";

    // Update modal title and content
    document.getElementById("resultModalLabel").textContent =
      "Heart Disease Risk Assessment Result";

    const resultMessage = `
        <div class="text-center mb-4">
            <h3 class="mb-3">Risk Assessment: ${riskResult}</h3>
            <p class="lead">Risk Probability: ${probability}%</p>
        </div>
        <div class="alert ${
          risk ? "alert-warning" : "alert-success"
        } text-center">
            ${
              risk
                ? "Please consult with a healthcare professional for a thorough evaluation."
                : "Continue maintaining your healthy lifestyle and regular check-ups."
            }
        </div>
    `;

    document.getElementById("resultContent").innerHTML = resultMessage;

    // Show the modal
    const resultModal = new bootstrap.Modal(
      document.getElementById("resultModal")
    );
    resultModal.show();
  }
</script>
{% endblock %}
